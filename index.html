<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MITI - Monthly Test System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); min-height: 100vh; color: #fff; }
        .screen { display: none; }
        .screen.active { display: block; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box, .result-box { background: #2d2d2d; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: 100%; max-width: 500px; border: 1px solid #444; }
        h1 { color: #fff; text-align: center; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        h2 { color: #fff; margin-bottom: 20px; text-align: center; }
        h3 { color: #fff; margin: 20px 0 10px 0; }
        input, select, textarea { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #444; border-radius: 8px; font-size: 16px; background: #1a1a1a; color: #fff; }
        textarea { min-height: 100px; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4CAF50; }
        select option { background: #1a1a1a; color: #fff; }
        button { width: 100%; padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .error { color: #ff6b6b; margin-top: 10px; text-align: center; font-weight: bold; }
        .success { color: #4CAF50; margin-top: 10px; text-align: center; font-weight: bold; }
        .info { color: #2196F3; margin-top: 10px; text-align: center; font-size: 14px; }
        .test-header { background: #2d2d2d; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); flex-wrap: wrap; gap: 10px; border-bottom: 2px solid #4CAF50; }
        .timer { font-size: 24px; font-weight: bold; color: #ff6b6b; padding: 10px 20px; background: #1a1a1a; border-radius: 8px; border: 2px solid #ff6b6b; }
        .month-badge { background: #4CAF50; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; }
        .trade-badge { background: #2196F3; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; }
        .test-container { max-width: 900px; margin: 30px auto; background: #2d2d2d; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #444; }
        .progress-bar { width: 100%; height: 8px; background: #1a1a1a; border-radius: 10px; margin-bottom: 30px; border: 1px solid #444; }
        .progress { height: 100%; background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%); transition: width 0.3s; border-radius: 10px; }
        .option { padding: 15px; margin: 10px 0; border: 2px solid #444; border-radius: 8px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; background: #1a1a1a; text-align: left; width: 100%; }
        .option:hover { border-color: #4CAF50; background: #2d2d2d; }
        .option.selected { border-color: #4CAF50; background: #4CAF50; color: white; }
        .option input[type="radio"] { margin-right: 15px; width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; }
        .option-text { flex: 1; }
        .navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .navigation button { width: auto; padding: 12px 30px; }
        .result-details { margin: 30px 0; padding: 20px; background: #1a1a1a; border-radius: 8px; border: 1px solid #444; }
        .result-details p { margin: 15px 0; font-size: 18px; color: #fff; }
        .result-details span { color: #4CAF50; font-weight: bold; }
        .score-display { font-size: 48px; text-align: center; color: #4CAF50; font-weight: bold; margin: 20px 0; }
        table { width: 100%; background: #2d2d2d; border-collapse: collapse; margin-top: 20px; border-radius: 8px; overflow: hidden; border: 1px solid #444; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; color: #fff; }
        th { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; font-weight: bold; }
        tr:hover { background: #1a1a1a; }
        .month-select { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .month-btn { padding: 20px; background: #1a1a1a; border: 2px solid #444; border-radius: 10px; cursor: pointer; text-align: center; font-weight: bold; transition: all 0.3s; color: #fff; position: relative; }
        .month-btn:hover:not(.completed):not(.locked) { border-color: #4CAF50; background: #2d2d2d; }
        .month-btn.selected { border-color: #4CAF50; background: #4CAF50; color: white; }
        .month-btn.completed { border-color: #4CAF50; }
        .month-btn.completed::after { content: '‚úÖ'; position: absolute; top: 10px; right: 10px; font-size: 20px; }
        .month-btn.locked { opacity: 0.5; cursor: not-allowed; border-color: #ff6b6b; }
        .month-btn.locked::after { content: 'üîí'; position: absolute; top: 10px; right: 10px; font-size: 20px; }
        .footer { position: fixed; bottom: 10px; right: 20px; color: #888; font-size: 14px; font-style: italic; }
        .question h3 { color: #fff; margin-bottom: 20px; text-align: left; }
        .question p { color: #ddd; text-align: left; font-size: 18px; margin-bottom: 20px; }
        #questionCounter { color: #4CAF50; font-weight: bold; }
        .admin-btn { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%) !important; margin-top: 20px; }
        
        /* ADMIN PANEL STYLES */
        .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .admin-header h1 { font-size: 28px; margin: 0; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; width: auto; margin: 0; }
        .logout-btn:hover { background: white; color: #667eea; transform: translateY(-2px); }
        
        .admin-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #ddd; }
        .admin-tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; background: #f8f9fa; }
        .admin-tab:hover { background: #e9ecef; }
        .admin-tab.active { color: #667eea; background: #2d2d2d; border-bottom: 3px solid #667eea; }
        
        .tab-content { display: none; padding: 30px; background: #2d2d2d; }
        .tab-content.active { display: block; }
        
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
        .left-actions { display: flex; gap: 10px; }
        .right-actions { display: flex; gap: 10px; }
        
        .btn-small { padding: 10px 20px; font-size: 14px; width: auto; margin: 0; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #333; }
        
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .settings-card { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .settings-card h4 { color: #4CAF50; margin-bottom: 15px; }
        
        .trade-item { background: #1a1a1a; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .trade-item span { color: #fff; font-weight: 600; }
        
        .timing-item { background: #1a1a1a; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; }
        .timing-item h5 { color: #4CAF50; margin-bottom: 10px; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #2d2d2d; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #444; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: #4CAF50; margin: 0; }
        .close-modal { font-size: 28px; cursor: pointer; color: #ff6b6b; font-weight: bold; }
        .close-modal:hover { color: #f44336; }
        
        .question-card { background: #1a1a1a; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; }
        .question-card h4 { color: #4CAF50; margin-bottom: 10px; }
        .question-card p { margin: 5px 0; color: #ddd; }
        .question-actions { display: flex; gap: 10px; margin-top: 15px; }
        
        @media (max-width: 768px) {
            .admin-header { flex-direction: column; gap: 15px; }
            .action-bar { flex-direction: column; }
            .left-actions, .right-actions { width: 100%; flex-direction: column; }
            .btn-small { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- STUDENT LOGIN SCREEN -->
    <div id="loginScreen" class="screen active">
        <div class="container">
            <h1>üìö MITI Test System</h1>
            <div class="login-box">
                <h2>Student Login</h2>
                <input type="text" id="studentName" placeholder="Enter your name" required>
                <input type="text" id="studentId" placeholder="Enter your ID" required>
                <select id="tradeSelect" required>
                    <option value="">Select Trade</option>
                </select>
                <button onclick="studentLogin()">Start Test</button>
                <button class="admin-btn" onclick="showAdminLogin()">Admin Panel</button>
                <div id="loginError" class="error"></div>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN SCREEN -->
    <div id="adminLoginScreen" class="screen">
        <div class="container">
            <h1>üîê Admin Login</h1>
            <div class="login-box">
                <h2>Admin Access</h2>
                <input type="text" id="adminUsername" placeholder="Username" required>
                <input type="password" id="adminPassword" placeholder="Password" required>
                <button onclick="adminLogin()">Login</button>
                <button onclick="backToStudentLogin()">Back to Student Login</button>
                <div id="adminLoginError" class="error"></div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="screen">
        <div class="admin-header">
            <h1>üìä Admin Panel</h1>
            <button class="logout-btn" onclick="adminLogout()">üö™ Logout</button>
        </div>
        
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="switchAdminTab('results')">üìà Test Results</div>
            <div class="admin-tab" onclick="switchAdminTab('questions')">üìù Manage Questions</div>
            <div class="admin-tab" onclick="switchAdminTab('schedule')">üìÖ Test Schedule</div>
            <div class="admin-tab" onclick="switchAdminTab('trades')">üè¢ Manage Trades</div>
            <div class="admin-tab" onclick="switchAdminTab('settings')">‚öôÔ∏è Settings</div>
        </div>

        <!-- RESULTS TAB -->
        <div id="resultsTab" class="tab-content active">
            <div class="action-bar">
                <div class="left-actions"></div>
                <div class="right-actions">
                    <button class="btn-small btn-success" onclick="exportAllResults()">üì• Export All Results</button>
                    <button class="btn-small btn-danger" onclick="clearAllResults()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
            <div id="resultsContainer"></div>
        </div>

        <!-- QUESTIONS TAB -->
        <div id="questionsTab" class="tab-content">
            <div class="action-bar">
                <div class="left-actions">
                    <button class="btn-small btn-primary" onclick="openAddQuestionModal()">‚ûï Add Question</button>
                    <button class="btn-small btn-success" onclick="saveAllQuestions()">üíæ Save Changes</button>
                </div>
                <div class="right-actions"></div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <select id="filterTrade" onchange="loadQuestions()" style="width: auto;">
                    <option value="">Select Trade</option>
                </select>
                <select id="filterMonth" onchange="loadQuestions()" style="width: auto;">
                    <option value="">Select Month</option>
                    <option value="1">Month 1</option>
                    <option value="2">Month 2</option>
                    <option value="3">Month 3</option>
                    <option value="4">Month 4</option>
                </select>
            </div>
            <div id="questionsContainer"></div>
        </div>

        <!-- SCHEDULE TAB -->
        <div id="scheduleTab" class="tab-content">
            <div class="action-bar">
                <div class="left-actions">
                    <button class="btn-small btn-success" onclick="saveSchedule()">üíæ Save Schedule</button>
                </div>
                <div class="right-actions"></div>
            </div>
            <div id="scheduleContainer"></div>
        </div>

        <!-- TRADES TAB -->
        <div id="tradesTab" class="tab-content">
            <div class="action-bar">
                <div class="left-actions">
                    <button class="btn-small btn-primary" onclick="openAddTradeModal()">‚ûï Add Trade</button>
                </div>
                <div class="right-actions"></div>
            </div>
            <div id="tradesContainer"></div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settingsTab" class="tab-content">
            <div class="settings-grid">
                <div class="settings-card">
                    <h4>üîê Change Admin Credentials</h4>
                    <input type="text" id="newAdminUsername" placeholder="New Username">
                    <input type="password" id="newAdminPassword" placeholder="New Password">
                    <button class="btn-small btn-success" onclick="updateAdminCredentials()">Update Credentials</button>
                </div>
                
                <div class="settings-card">
                    <h4>‚è∞ Default Test Timing</h4>
                    <label style="color: #ddd; display: block; margin: 10px 0;">Test Duration (minutes)</label>
                    <input type="number" id="defaultTestDuration" placeholder="30" value="30">
                    <button class="btn-small btn-success" onclick="saveDefaultTiming()">Save Timing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MONTH SELECTION SCREEN -->
    <div id="monthScreen" class="screen">
        <div class="container">
            <h1>Select Month</h1>
            <div class="login-box">
                <h2 id="studentInfo"></h2>
                <div class="month-select" id="monthSelect"></div>
                <button onclick="backToLogin()">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- TEST SCREEN -->
    <div id="testScreen" class="screen">
        <div class="test-header">
            <div class="month-badge" id="currentMonth"></div>
            <div class="timer" id="timer">30:00</div>
            <div class="trade-badge" id="currentTrade"></div>
        </div>
        <div class="test-container">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div id="questionContainer"></div>
            <div class="navigation">
                <button onclick="previousQuestion()" id="prevBtn">‚¨ÖÔ∏è Previous</button>
                <span id="questionCounter"></span>
                <button onclick="nextQuestion()" id="nextBtn">Next ‚û°Ô∏è</button>
            </div>
        </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="resultScreen" class="screen">
        <div class="container">
            <h1>Test Completed! üéâ</h1>
            <div class="result-box">
                <div class="score-display" id="scoreDisplay"></div>
                <div class="result-details" id="resultDetails"></div>
                <button onclick="backToMonthSelection()">Back to Month Selection</button>
                <button onclick="backToLogin()">Logout</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Question</h3>
                <span class="close-modal" onclick="closeQuestionModal()">&times;</span>
            </div>
            <form id="questionForm" onsubmit="saveQuestion(event)">
                <select id="modalTrade" required>
                    <option value="">Select Trade</option>
                </select>
                <select id="modalMonth" required>
                    <option value="">Select Month</option>
                    <option value="1">Month 1</option>
                    <option value="2">Month 2</option>
                    <option value="3">Month 3</option>
                    <option value="4">Month 4</option>
                </select>
                <textarea id="modalQuestion" placeholder="Question" required></textarea>
                <input type="text" id="modalOptionA" placeholder="Option A" required>
                <input type="text" id="modalOptionB" placeholder="Option B" required>
                <input type="text" id="modalOptionC" placeholder="Option C" required>
                <input type="text" id="modalOptionD" placeholder="Option D" required>
                <select id="modalCorrect" required>
                    <option value="">Correct Answer</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
                <button type="submit" class="btn-small btn-success" style="width: 100%;">Save Question</button>
            </form>
        </div>
    </div>

    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Trade</h3>
                <span class="close-modal" onclick="closeTradeModal()">&times;</span>
            </div>
            <input type="text" id="newTradeName" placeholder="Trade Name (e.g., Web Development)">
            <input type="text" id="newTradeId" placeholder="Trade ID (e.g., webdev)">
            <button class="btn-small btn-success" onclick="addNewTrade()" style="width: 100%;">Add Trade</button>
        </div>
    </div>

    <div class="footer">Developed by Faris Bilal</div>

    <script>
        // HARDCODED DEFAULTS (FALLBACK)
        const DEFAULT_ADMIN = { username: 'admin', password: 'admin123' };
        const DEFAULT_TRADES = [
            { id: 'accounting', name: 'Computerized Accounting' },
            { id: 'dataanalytics', name: 'Data Analytics with AI' }
        ];
        const DEFAULT_DURATION = 30;

        // Initialize system
        let currentStudent = null;
        let currentTrade = null;
        let currentMonth = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questions = [];
        let timerInterval = null;
        let timeLeft = 1800;
        let editingQuestionIndex = null;

        // Initialize with guaranteed defaults
        function initializeSystem() {
            // FORCE RESET if localStorage is corrupted
            try {
                const test = localStorage.getItem('adminCredentials');
                if (!test || test === 'undefined' || test === 'null') {
                    throw new Error('Corrupted localStorage');
                }
            } catch (e) {
                console.log('Resetting localStorage...');
                localStorage.clear();
            }

            // Set admin credentials with fallback
            if (!localStorage.getItem('adminCredentials')) {
                localStorage.setItem('adminCredentials', JSON.stringify(DEFAULT_ADMIN));
            }
            
            // Set trades with fallback
            if (!localStorage.getItem('trades')) {
                localStorage.setItem('trades', JSON.stringify(DEFAULT_TRADES));
            }
            
            // Set test duration with fallback
            if (!localStorage.getItem('testDuration')) {
                localStorage.setItem('testDuration', String(DEFAULT_DURATION));
            }
            
            loadTradesIntoSelect();
        }

        function loadTradesIntoSelect() {
            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            const select = document.getElementById('tradeSelect');
            select.innerHTML = '<option value="">Select Trade</option>';
            trades.forEach(trade => {
                select.innerHTML += `<option value="${trade.id}">${trade.name}</option>`;
            });
        }

        // Student Login
        function studentLogin() {
            const name = document.getElementById('studentName').value.trim();
            const id = document.getElementById('studentId').value.trim();
            const trade = document.getElementById('tradeSelect').value;

            if (!name || !id || !trade) {
                document.getElementById('loginError').textContent = 'Please fill all fields!';
                return;
            }

            currentStudent = { name, id, trade };
            showScreen('monthScreen');
            document.getElementById('studentInfo').textContent = `Welcome, ${name}!`;
            loadMonthSelection();
        }

        function loadMonthSelection() {
            const container = document.getElementById('monthSelect');
            const results = JSON.parse(localStorage.getItem('testResults') || '[]');
            const schedule = JSON.parse(localStorage.getItem('testSchedule') || '{}');
            const today = new Date().toISOString().split('T')[0];

            container.innerHTML = '';
            for (let month = 1; month <= 4; month++) {
                const completed = results.some(r => 
                    r.name === currentStudent.name && 
                    r.id === currentStudent.id && 
                    r.trade === currentStudent.trade && 
                    r.month === month
                );

                const scheduleKey = `${currentStudent.trade}_${month}`;
                const scheduleData = schedule[scheduleKey] || {};
                const isLocked = scheduleData.startDate && scheduleData.endDate && 
                    (today < scheduleData.startDate || today > scheduleData.endDate);

                const btn = document.createElement('div');
                btn.className = `month-btn ${completed ? 'completed' : ''} ${isLocked ? 'locked' : ''}`;
                btn.innerHTML = `Month ${month}`;
                
                if (!completed && !isLocked) {
                    btn.onclick = () => startTest(month);
                }
                
                container.appendChild(btn);
            }
        }

        function startTest(month) {
            currentMonth = month;
            const key = `questions_${currentStudent.trade}_${month}`;
            questions = JSON.parse(localStorage.getItem(key) || '[]');

            if (questions.length === 0) {
                alert('No questions available for this month!');
                return;
            }

            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length).fill(null);
            
            // GUARANTEED 30 MINUTES
            const duration = parseInt(localStorage.getItem('testDuration') || String(DEFAULT_DURATION));
            timeLeft = duration * 60;

            showScreen('testScreen');
            document.getElementById('currentMonth').textContent = `Month ${month}`;
            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            const tradeName = trades.find(t => t.id === currentStudent.trade)?.name || currentStudent.trade;
            document.getElementById('currentTrade').textContent = tradeName;
            
            startTimer();
            displayQuestion();
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            const container = document.getElementById('questionContainer');
            
            container.innerHTML = `
                <div class="question">
                    <h3>Question ${currentQuestionIndex + 1} of ${questions.length}</h3>
                    <p>${question.question}</p>
                    ${['A', 'B', 'C', 'D'].map(opt => `
                        <label class="option ${userAnswers[currentQuestionIndex] === opt ? 'selected' : ''}">
                            <input type="radio" name="answer" value="${opt}" 
                                ${userAnswers[currentQuestionIndex] === opt ? 'checked' : ''}
                                onchange="selectAnswer('${opt}')">
                            <span class="option-text">${opt}. ${question.options[opt]}</span>
                        </label>
                    `).join('')}
                </div>
            `;

            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').textContent = 
                currentQuestionIndex === questions.length - 1 ? 'Submit Test' : 'Next ‚û°Ô∏è';
            
            updateProgress();
        }

        function selectAnswer(answer) {
            userAnswers[currentQuestionIndex] = answer;
            displayQuestion();
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                submitTest();
            }
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('questionCounter').textContent = 
                `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
            }, 1000);
        }

        function submitTest() {
            clearInterval(timerInterval);
            
            let score = 0;
            questions.forEach((q, i) => {
                if (userAnswers[i] === q.correct) score++;
            });

            const result = {
                name: currentStudent.name,
                id: currentStudent.id,
                trade: currentStudent.trade,
                month: currentMonth,
                score: score,
                total: questions.length,
                timestamp: new Date().toISOString()
            };

            const results = JSON.parse(localStorage.getItem('testResults') || '[]');
            results.push(result);
            localStorage.setItem('testResults', JSON.stringify(results));

            showScreen('resultScreen');
            document.getElementById('scoreDisplay').textContent = `${score}/${questions.length}`;
            
            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            const tradeName = trades.find(t => t.id === currentStudent.trade)?.name || currentStudent.trade;
            
            document.getElementById('resultDetails').innerHTML = `
                <p><strong>Name:</strong> <span>${currentStudent.name}</span></p>
                <p><strong>ID:</strong> <span>${currentStudent.id}</span></p>
                <p><strong>Trade:</strong> <span>${tradeName}</span></p>
                <p><strong>Month:</strong> <span>${currentMonth}</span></p>
                <p><strong>Score:</strong> <span>${score}/${questions.length}</span></p>
                <p><strong>Percentage:</strong> <span>${((score/questions.length)*100).toFixed(1)}%</span></p>
            `;
        }

        // Admin Functions
        function showAdminLogin() {
            showScreen('adminLoginScreen');
        }

        function adminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            // Get credentials with fallback
            let credentials;
            try {
                credentials = JSON.parse(localStorage.getItem('adminCredentials') || JSON.stringify(DEFAULT_ADMIN));
            } catch (e) {
                credentials = DEFAULT_ADMIN;
            }

            if (username === credentials.username && password === credentials.password) {
                showScreen('adminPanel');
                loadAdminData();
                document.getElementById('adminLoginError').textContent = '';
            } else {
                document.getElementById('adminLoginError').textContent = 'Invalid credentials!';
            }
        }

        function adminLogout() {
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginError').textContent = '';
            showScreen('loginScreen');
        }

        function loadAdminData() {
            loadResults();
            loadTradesManagement();
            loadScheduleManagement();
            loadTradesIntoFilters();
            
            // Load current duration into settings
            const duration = localStorage.getItem('testDuration') || String(DEFAULT_DURATION);
            document.getElementById('defaultTestDuration').value = duration;
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'results') loadResults();
            if (tab === 'questions') loadQuestions();
            if (tab === 'schedule') loadScheduleManagement();
            if (tab === 'trades') loadTradesManagement();
        }

        function loadResults() {
            const results = JSON.parse(localStorage.getItem('testResults') || '[]');
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No results yet</p>';
                return;
            }

            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            let html = '<table><thead><tr><th>Name</th><th>ID</th><th>Trade</th><th>Month</th><th>Score</th><th>Date</th></tr></thead><tbody>';
            
            results.forEach(result => {
                const tradeName = trades.find(t => t.id === result.trade)?.name || result.trade;
                html += `
                    <tr>
                        <td>${result.name}</td>
                        <td>${result.id}</td>
                        <td>${tradeName}</td>
                        <td>Month ${result.month}</td>
                        <td>${result.score}/${result.total}</td>
                        <td>${new Date(result.timestamp).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function exportAllResults() {
            const results = JSON.parse(localStorage.getItem('testResults') || '[]');
            if (results.length === 0) {
                alert('No results to export!');
                return;
            }

            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            const studentData = {};

            results.forEach(result => {
                const key = `${result.name}_${result.id}_${result.trade}`;
                if (!studentData[key]) {
                    const tradeName = trades.find(t => t.id === result.trade)?.name || result.trade;
                    studentData[key] = {
                        name: result.name,
                        id: result.id,
                        trade: tradeName,
                        months: {}
                    };
                }
                studentData[key].months[result.month] = result.score;
            });

            let csv = 'Name,ID,Trade,Month 1,Month 2,Month 3,Month 4,Total\n';
            
            Object.values(studentData).forEach(student => {
                const m1 = student.months['1'] || '';
                const m2 = student.months['2'] || '';
                const m3 = student.months['3'] || '';
                const m4 = student.months['4'] || '';
                
                const scores = [m1, m2, m3, m4].filter(s => s !== '');
                const total = scores.length > 0 ? scores.reduce((a, b) => parseInt(a) + parseInt(b), 0) : '';
                
                csv += `${student.name},${student.id},${student.trade},${m1},${m2},${m3},${m4},${total}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'all_test_results.csv';
            a.click();
        }

        function clearAllResults() {
            if (confirm('Are you sure? This will delete all test results!')) {
                localStorage.removeItem('testResults');
                loadResults();
                alert('All results cleared!');
            }
        }

        function loadTradesIntoFilters() {
            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            const selects = [document.getElementById('filterTrade'), document.getElementById('modalTrade')];
            
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Trade</option>';
                trades.forEach(trade => {
                    select.innerHTML += `<option value="${trade.id}">${trade.name}</option>`;
                });
                select.value = currentValue;
            });
        }

        function loadQuestions() {
            const trade = document.getElementById('filterTrade').value;
            const month = document.getElementById('filterMonth').value;
            const container = document.getElementById('questionsContainer');

            if (!trade || !month) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Please select trade and month</p>';
                return;
            }

            const key = `questions_${trade}_${month}`;
            const questions = JSON.parse(localStorage.getItem(key) || '[]');

            if (questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No questions found</p>';
                return;
            }

            let html = '';
            questions.forEach((q, index) => {
                html += `
                    <div class="question-card">
                        <h4>Q${index + 1}: ${q.question}</h4>
                        <p>A) ${q.options.A} ${q.correct === 'A' ? '‚úÖ' : ''}</p>
                        <p>B) ${q.options.B} ${q.correct === 'B' ? '‚úÖ' : ''}</p>
                        <p>C) ${q.options.C} ${q.correct === 'C' ? '‚úÖ' : ''}</p>
                        <p>D) ${q.options.D} ${q.correct === 'D' ? '‚úÖ' : ''}</p>
                        <div class="question-actions">
                            <button class="btn-small btn-warning" onclick="editQuestion(${index})">‚úèÔ∏è Edit</button>
                            <button class="btn-small btn-danger" onclick="deleteQuestion(${index})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function openAddQuestionModal() {
            editingQuestionIndex = null;
            document.getElementById('modalTitle').textContent = 'Add Question';
            document.getElementById('questionForm').reset();
            document.getElementById('questionModal').classList.add('active');
        }

        function editQuestion(index) {
            const trade = document.getElementById('filterTrade').value;
            const month = document.getElementById('filterMonth').value;
            const key = `questions_${trade}_${month}`;
            const questions = JSON.parse(localStorage.getItem(key) || '[]');
            const q = questions[index];

            editingQuestionIndex = index;
            document.getElementById('modalTitle').textContent = 'Edit Question';
            document.getElementById('modalTrade').value = trade;
            document.getElementById('modalMonth').value = month;
            document.getElementById('modalQuestion').value = q.question;
            document.getElementById('modalOptionA').value = q.options.A;
            document.getElementById('modalOptionB').value = q.options.B;
            document.getElementById('modalOptionC').value = q.options.C;
            document.getElementById('modalOptionD').value = q.options.D;
            document.getElementById('modalCorrect').value = q.correct;
            
            document.getElementById('questionModal').classList.add('active');
        }

        function deleteQuestion(index) {
            if (!confirm('Delete this question?')) return;

            const trade = document.getElementById('filterTrade').value;
            const month = document.getElementById('filterMonth').value;
            const key = `questions_${trade}_${month}`;
            const questions = JSON.parse(localStorage.getItem(key) || '[]');
            
            questions.splice(index, 1);
            localStorage.setItem(key, JSON.stringify(questions));
            loadQuestions();
        }

        function saveQuestion(e) {
            e.preventDefault();

            const trade = document.getElementById('modalTrade').value;
            const month = document.getElementById('modalMonth').value;
            const key = `questions_${trade}_${month}`;
            
            const questionData = {
                question: document.getElementById('modalQuestion').value,
                options: {
                    A: document.getElementById('modalOptionA').value,
                    B: document.getElementById('modalOptionB').value,
                    C: document.getElementById('modalOptionC').value,
                    D: document.getElementById('modalOptionD').value
                },
                correct: document.getElementById('modalCorrect').value
            };

            const questions = JSON.parse(localStorage.getItem(key) || '[]');

            if (editingQuestionIndex !== null) {
                questions[editingQuestionIndex] = questionData;
            } else {
                questions.push(questionData);
            }

            localStorage.setItem(key, JSON.stringify(questions));
            closeQuestionModal();
            
            document.getElementById('filterTrade').value = trade;
            document.getElementById('filterMonth').value = month;
            loadQuestions();
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.remove('active');
        }

        function saveAllQuestions() {
            alert('All changes saved successfully!');
        }

        function loadScheduleManagement() {
            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            const schedule = JSON.parse(localStorage.getItem('testSchedule') || '{}');
            const container = document.getElementById('scheduleContainer');

            let html = '<div class="settings-grid">';

            trades.forEach(trade => {
                for (let month = 1; month <= 4; month++) {
                    const key = `${trade.id}_${month}`;
                    const data = schedule[key] || { startDate: '', endDate: '' };

                    html += `
                        <div class="settings-card">
                            <h4>${trade.name} - Month ${month}</h4>
                            <label style="color: #ddd; display: block; margin: 10px 0;">Start Date</label>
                            <input type="date" id="start_${key}" value="${data.startDate}">
                            <label style="color: #ddd; display: block; margin: 10px 0;">End Date</label>
                            <input type="date" id="end_${key}" value="${data.endDate}">
                        </div>
                    `;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function saveSchedule() {
            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            const schedule = {};

            trades.forEach(trade => {
                for (let month = 1; month <= 4; month++) {
                    const key = `${trade.id}_${month}`;
                    schedule[key] = {
                        startDate: document.getElementById(`start_${key}`).value,
                        endDate: document.getElementById(`end_${key}`).value
                    };
                }
            });

            localStorage.setItem('testSchedule', JSON.stringify(schedule));
            alert('Schedule saved successfully!');
        }

        function loadTradesManagement() {
            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            const container = document.getElementById('tradesContainer');

            let html = '';
            trades.forEach((trade, index) => {
                html += `
                    <div class="trade-item">
                        <span>${trade.name} (${trade.id})</span>
                        <button class="btn-small btn-danger" onclick="deleteTrade(${index})">üóëÔ∏è Delete</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function openAddTradeModal() {
            document.getElementById('tradeModal').classList.add('active');
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').classList.remove('active');
        }

        function addNewTrade() {
            const name = document.getElementById('newTradeName').value.trim();
            const id = document.getElementById('newTradeId').value.trim().toLowerCase();

            if (!name || !id) {
                alert('Please fill all fields!');
                return;
            }

            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            
            if (trades.some(t => t.id === id)) {
                alert('Trade ID already exists!');
                return;
            }

            trades.push({ id, name });
            localStorage.setItem('trades', JSON.stringify(trades));
            
            closeTradeModal();
            loadTradesManagement();
            loadTradesIntoSelect();
            loadTradesIntoFilters();
            alert('Trade added successfully!');
        }

        function deleteTrade(index) {
            if (!confirm('Delete this trade? This will also delete all associated questions and results!')) return;

            const trades = JSON.parse(localStorage.getItem('trades') || JSON.stringify(DEFAULT_TRADES));
            trades.splice(index, 1);
            localStorage.setItem('trades', JSON.stringify(trades));
            
            loadTradesManagement();
            loadTradesIntoSelect();
            loadTradesIntoFilters();
        }

        function updateAdminCredentials() {
            const username = document.getElementById('newAdminUsername').value.trim();
            const password = document.getElementById('newAdminPassword').value.trim();

            if (!username || !password) {
                alert('Please fill both fields!');
                return;
            }

            localStorage.setItem('adminCredentials', JSON.stringify({ username, password }));
            alert('Admin credentials updated successfully!');
            document.getElementById('newAdminUsername').value = '';
            document.getElementById('newAdminPassword').value = '';
        }

        function saveDefaultTiming() {
            const duration = document.getElementById('defaultTestDuration').value;
            if (!duration || duration < 1) {
                alert('Please enter a valid duration!');
                return;
            }

            localStorage.setItem('testDuration', String(duration));
            alert('Default timing saved successfully!');
        }

        function backToStudentLogin() {
            document.getElementById('adminLoginError').textContent = '';
            showScreen('loginScreen');
        }

        function backToLogin() {
            currentStudent = null;
            currentTrade = null;
            currentMonth = null;
            document.getElementById('loginError').textContent = '';
            showScreen('loginScreen');
        }

        function backToMonthSelection() {
            showScreen('monthScreen');
            loadMonthSelection();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Initialize on load
        initializeSystem();
    </script>
</body>
</html>