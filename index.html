<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MITI - Monthly Test System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); min-height: 100vh; color: #fff; }
        .screen { display: none; }
        .screen.active { display: block; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box, .result-box { background: #2d2d2d; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: 100%; max-width: 500px; border: 1px solid #444; }
        h1 { color: #fff; text-align: center; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        h2 { color: #fff; margin-bottom: 20px; text-align: center; }
        h3 { color: #fff; margin: 20px 0 10px 0; }
        input, select, textarea { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #444; border-radius: 8px; font-size: 16px; background: #1a1a1a; color: #fff; }
        textarea { min-height: 100px; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4CAF50; }
        select option { background: #1a1a1a; color: #fff; }
        button { width: 100%; padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .error { color: #ff6b6b; margin-top: 10px; text-align: center; font-weight: bold; }
        .success { color: #4CAF50; margin-top: 10px; text-align: center; font-weight: bold; }
        .warning { color: #ff9800; margin-top: 10px; text-align: center; font-weight: bold; }
        .info { color: #2196F3; margin-top: 10px; text-align: center; font-size: 14px; }
        .test-header { background: #2d2d2d; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); flex-wrap: wrap; gap: 10px; border-bottom: 2px solid #4CAF50; position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        .timer { font-size: 24px; font-weight: bold; color: #ff6b6b; padding: 10px 20px; background: #1a1a1a; border-radius: 8px; border: 2px solid #ff6b6b; }
        .warning-badge { background: #ff9800; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .month-badge { background: #4CAF50; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; }
        .trade-badge { background: #2196F3; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; }
        .test-container { max-width: 900px; margin: 120px auto 30px; background: #2d2d2d; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #444; }
        .progress-bar { width: 100%; height: 8px; background: #1a1a1a; border-radius: 10px; margin-bottom: 30px; border: 1px solid #444; }
        .progress { height: 100%; background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%); transition: width 0.3s; border-radius: 10px; }
        .option { padding: 15px; margin: 10px 0; border: 2px solid #444; border-radius: 8px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; background: #1a1a1a; text-align: left; width: 100%; }
        .option:hover { border-color: #4CAF50; background: #2d2d2d; }
        .option.selected { border-color: #4CAF50; background: #4CAF50; color: white; }
        .option input[type="radio"] { margin-right: 15px; width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; }
        .option-text { flex: 1; }
        .navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .navigation button { width: auto; padding: 12px 30px; }
        .result-details { margin: 30px 0; padding: 20px; background: #1a1a1a; border-radius: 8px; border: 1px solid #444; }
        .result-details p { margin: 15px 0; font-size: 18px; color: #fff; }
        .result-details span { color: #4CAF50; font-weight: bold; }
        .score-display { font-size: 48px; text-align: center; color: #4CAF50; font-weight: bold; margin: 20px 0; }
        table { width: 100%; background: #2d2d2d; border-collapse: collapse; margin-top: 20px; border-radius: 8px; overflow: hidden; border: 1px solid #444; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; color: #fff; }
        th { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; font-weight: bold; }
        tr:hover { background: #1a1a1a; }
        .month-select { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .month-btn { padding: 20px; background: #1a1a1a; border: 2px solid #444; border-radius: 10px; cursor: pointer; text-align: center; font-weight: bold; transition: all 0.3s; color: #fff; position: relative; }
        .month-btn:hover:not(.completed):not(.locked) { border-color: #4CAF50; background: #2d2d2d; }
        .month-btn.selected { border-color: #4CAF50; background: #4CAF50; color: white; }
        .month-btn.completed { border-color: #4CAF50; }
        .month-btn.completed::after { content: '‚úÖ'; position: absolute; top: 10px; right: 10px; font-size: 20px; }
        .month-btn.locked { opacity: 0.5; cursor: not-allowed; border-color: #ff6b6b; }
        .month-btn.locked::after { content: 'üîí'; position: absolute; top: 10px; right: 10px; font-size: 20px; }
        .footer { position: fixed; bottom: 10px; right: 20px; color: #888; font-size: 14px; font-style: italic; }
        .question h3 { color: #fff; margin-bottom: 20px; text-align: left; }
        .question p { color: #ddd; text-align: left; font-size: 18px; margin-bottom: 20px; }
        #questionCounter { color: #4CAF50; font-weight: bold; }
        .admin-btn { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%) !important; margin-top: 20px; }
        .teacher-btn { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%) !important; margin-top: 10px; }
        
        /* ADMIN PANEL STYLES */
        .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .admin-header h1 { font-size: 28px; margin: 0; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; width: auto; margin: 0; }
        .logout-btn:hover { background: white; color: #667eea; transform: translateY(-2px); }
        
        .admin-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #ddd; }
        .admin-tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; background: #f8f9fa; }
        .admin-tab:hover { background: #e9ecef; }
        .admin-tab.active { color: #667eea; background: #2d2d2d; border-bottom: 3px solid #667eea; }
        
        .tab-content { display: none; padding: 30px; background: #2d2d2d; }
        .tab-content.active { display: block; }
        
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
        .left-actions { display: flex; gap: 10px; }
        .right-actions { display: flex; gap: 10px; }
        
        .btn-small { padding: 10px 20px; font-size: 14px; width: auto; margin: 0; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #333; }
        
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .settings-card { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .settings-card h4 { color: #4CAF50; margin-bottom: 15px; }
        
        .trade-item { background: #1a1a1a; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .trade-item span { color: #fff; font-weight: 600; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #2d2d2d; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #444; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: #4CAF50; margin: 0; }
        .close-modal { font-size: 28px; cursor: pointer; color: #ff6b6b; font-weight: bold; }
        .close-modal:hover { color: #f44336; }
        
        .question-card { background: #1a1a1a; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; }
        .question-card h4 { color: #4CAF50; margin-bottom: 10px; }
        .question-card p { margin: 5px 0; color: #ddd; }
        .question-actions { display: flex; gap: 10px; margin-top: 15px; }
        
        .fullscreen-warning { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ff6b6b; color: white; padding: 30px; border-radius: 15px; z-index: 10000; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .fullscreen-warning h2 { margin-bottom: 15px; }
        
        @media (max-width: 768px) {
            .admin-header { flex-direction: column; gap: 15px; }
            .action-bar { flex-direction: column; }
            .left-actions, .right-actions { width: 100%; flex-direction: column; }
            .btn-small { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- STUDENT LOGIN SCREEN -->
    <div id="loginScreen" class="screen active">
        <div class="container">
            <h1>üìö MITI Test System</h1>
            <div class="login-box">
                <h2>Student Login</h2>
                <input type="text" id="studentName" placeholder="Enter your name" required>
                <input type="text" id="studentId" placeholder="Enter your ID" required>
                <select id="tradeSelect" required>
                    <option value="">Select Trade</option>
                </select>
                <button onclick="studentLogin()">Start Test</button>
                <button class="teacher-btn" onclick="showTeacherLogin()">Teacher Login</button>
                <div id="loginError" class="error"></div>
            </div>
        </div>
    </div>

    <!-- TEACHER LOGIN SCREEN -->
    <div id="teacherLoginScreen" class="screen">
        <div class="container">
            <h1>üë®‚Äçüè´ Teacher Login</h1>
            <div class="login-box">
                <h2>Teacher Access</h2>
                <input type="text" id="teacherUsername" placeholder="Username" required>
                <input type="password" id="teacherPassword" placeholder="Password" required>
                <button onclick="teacherLogin()">Login</button>
                <button onclick="showTeacherRegister()">Register New Teacher</button>
                <button onclick="backToStudentLogin()">Back to Student Login</button>
                <div id="teacherLoginError" class="error"></div>
            </div>
        </div>
    </div>

    <!-- TEACHER REGISTRATION SCREEN -->
    <div id="teacherRegisterScreen" class="screen">
        <div class="container">
            <h1>üìù Teacher Registration</h1>
            <div class="login-box">
                <h2>Create Teacher Account</h2>
                <input type="text" id="regName" placeholder="Full Name" required>
                <input type="email" id="regEmail" placeholder="Email" required>
                <input type="text" id="regUsername" placeholder="Username" required>
                <input type="password" id="regPassword" placeholder="Password" required>
                <select id="regTrade" required>
                    <option value="">Select Your Trade</option>
                </select>
                <button onclick="registerTeacher()">Register</button>
                <button onclick="showTeacherLogin()">Back to Login</button>
                <div id="registerError" class="error"></div>
                <div id="registerSuccess" class="success"></div>
            </div>
        </div>
    </div>

    <!-- TEACHER PANEL -->
    <div id="teacherPanel" class="screen">
        <div class="admin-header">
            <h1>üë®‚Äçüè´ Teacher Panel</h1>
            <button class="logout-btn" onclick="teacherLogout()">üö™ Logout</button>
        </div>
        
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="switchTeacherTab('results')">üìà Test Results</div>
            <div class="admin-tab" onclick="switchTeacherTab('questions')">üìù Manage Questions</div>
            <div class="admin-tab" onclick="switchTeacherTab('schedule')">üìÖ Test Schedule</div>
        </div>

        <!-- RESULTS TAB -->
        <div id="resultsTab" class="tab-content active">
            <div class="action-bar">
                <div class="left-actions"></div>
                <div class="right-actions">
                    <button class="btn-small btn-success" onclick="exportResults()">üì• Export Results</button>
                </div>
            </div>
            <div id="resultsContainer"></div>
        </div>

        <!-- QUESTIONS TAB -->
        <div id="questionsTab" class="tab-content">
            <div class="action-bar">
                <div class="left-actions">
                    <button class="btn-small btn-primary" onclick="openAddQuestionModal()">‚ûï Add Question</button>
                </div>
                <div class="right-actions"></div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <select id="filterMonth" onchange="loadQuestions()" style="width: auto;">
                    <option value="">Select Month</option>
                    <option value="1">Month 1</option>
                    <option value="2">Month 2</option>
                    <option value="3">Month 3</option>
                    <option value="4">Month 4</option>
                </select>
            </div>
            <div id="questionsContainer"></div>
        </div>

        <!-- SCHEDULE TAB -->
        <div id="scheduleTab" class="tab-content">
            <div class="action-bar">
                <div class="left-actions">
                    <button class="btn-small btn-success" onclick="saveSchedule()">üíæ Save Schedule</button>
                </div>
                <div class="right-actions"></div>
            </div>
            <div id="scheduleContainer"></div>
        </div>
    </div>

    <!-- MONTH SELECTION SCREEN -->
    <div id="monthScreen" class="screen">
        <div class="container">
            <h1>Select Month</h1>
            <div class="login-box">
                <h2 id="studentInfo"></h2>
                <div class="month-select" id="monthSelect"></div>
                <button onclick="backToLogin()">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- TEST SCREEN -->
    <div id="testScreen" class="screen">
        <div class="test-header">
            <div class="month-badge" id="currentMonth"></div>
            <div class="timer" id="timer">30:00</div>
            <div class="warning-badge" id="warningBadge" style="display: none;">‚ö†Ô∏è Warnings: <span id="warningCount">0</span>/3</div>
            <div class="trade-badge" id="currentTrade"></div>
        </div>
        <div class="test-container">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div id="questionContainer"></div>
            <div class="navigation">
                <button onclick="previousQuestion()" id="prevBtn">‚¨ÖÔ∏è Previous</button>
                <span id="questionCounter"></span>
                <button onclick="nextQuestion()" id="nextBtn">Next ‚û°Ô∏è</button>
            </div>
        </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="resultScreen" class="screen">
        <div class="container">
            <h1>Test Completed! üéâ</h1>
            <div class="result-box">
                <div class="score-display" id="scoreDisplay"></div>
                <div class="result-details" id="resultDetails"></div>
                <button onclick="backToLogin()">Logout</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Question</h3>
                <span class="close-modal" onclick="closeQuestionModal()">&times;</span>
            </div>
            <form id="questionForm" onsubmit="saveQuestion(event)">
                <select id="modalMonth" required>
                    <option value="">Select Month</option>
                    <option value="1">Month 1</option>
                    <option value="2">Month 2</option>
                    <option value="3">Month 3</option>
                    <option value="4">Month 4</option>
                </select>
                <textarea id="modalQuestion" placeholder="Question" required></textarea>
                <input type="text" id="modalOptionA" placeholder="Option A" required>
                <input type="text" id="modalOptionB" placeholder="Option B" required>
                <input type="text" id="modalOptionC" placeholder="Option C" required>
                <input type="text" id="modalOptionD" placeholder="Option D" required>
                <select id="modalCorrect" required>
                    <option value="">Correct Answer</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
                <button type="submit" class="btn-small btn-success" style="width: 100%;">Save Question</button>
            </form>
        </div>
    </div>

    <div class="footer">Developed by Faris Bilal</div>

    <script>
        // SUPABASE CONFIGURATION
        const SUPABASE_URL = 'https://ldffoyzddpfvfhteebey.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkZmZveXpkZHBmdmZodGVlYmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY4Nzk0NzAsImV4cCI6MjA1MjQ1NTQ3MH0.YsFFwQ1v2qXhnDNAJ_GAMw_0w8Rl8OP';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // GLOBAL VARIABLES
        let currentStudent = null;
        let currentTeacher = null;
        let currentTrade = null;
        let currentMonth = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questions = [];
        let timerInterval = null;
        let timeLeft = 1800;
        let editingQuestionId = null;
        let warningCount = 0;
        let isFullscreen = false;

        // ANTI-CHEAT SYSTEM
        function initAntiCheat() {
            warningCount = 0;
            updateWarningDisplay();

            // Fullscreen detection
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);

            // Tab visibility detection
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // Prevent right-click
            document.addEventListener('contextmenu', e => e.preventDefault());

            // Prevent keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                    (e.ctrlKey && e.shiftKey && e.key === 'C') || (e.ctrlKey && e.key === 'u')) {
                    e.preventDefault();
                }
            });
        }

        function handleFullscreenChange() {
            isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                             document.mozFullScreenElement);
            
            if (!isFullscreen && document.getElementById('testScreen').classList.contains('active')) {
                addWarning('You exited fullscreen mode!');
            }
        }

        function handleVisibilityChange() {
            if (document.hidden && document.getElementById('testScreen').classList.contains('active')) {
                addWarning('You switched tabs!');
            }
        }

        function addWarning(message) {
            warningCount++;
            updateWarningDisplay();
            
            if (warningCount >= 3) {
                alert('‚ö†Ô∏è Too many warnings! Test will be auto-submitted.');
                submitTest(true);
            } else {
                alert(`‚ö†Ô∏è WARNING ${warningCount}/3: ${message}\nTest will auto-submit after 3 warnings!`);
            }
        }

        function updateWarningDisplay() {
            const badge = document.getElementById('warningBadge');
            const count = document.getElementById('warningCount');
            
            if (warningCount > 0) {
                badge.style.display = 'block';
                count.textContent = warningCount;
            } else {
                badge.style.display = 'none';
            }
        }

        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            }
        }

        // INITIALIZE SYSTEM
        async function initializeSystem() {
            await loadTrades();
        }

        async function loadTrades() {
            const { data, error } = await supabase.from('trades').select('*');
            
            if (error) {
                console.error('Error loading trades:', error);
                return;
            }

            const selects = [
                document.getElementById('tradeSelect'),
                document.getElementById('regTrade')
            ];
            
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Trade</option>';
                data.forEach(trade => {
                    select.innerHTML += `<option value="${trade.id}">${trade.name}</option>`;
                });
            });
        }

        // STUDENT LOGIN
        async function studentLogin() {
            const name = document.getElementById('studentName').value.trim();
            const id = document.getElementById('studentId').value.trim();
            const trade = document.getElementById('tradeSelect').value;

            if (!name || !id || !trade) {
                document.getElementById('loginError').textContent = 'Please fill all fields!';
                return;
            }

            currentStudent = { name, id, trade };
            showScreen('monthScreen');
            document.getElementById('studentInfo').textContent = `Welcome, ${name}!`;
            await loadMonthSelection();
        }

        async function loadMonthSelection() {
            const container = document.getElementById('monthSelect');
            
            // Check completed tests
            const { data: results } = await supabase
                .from('test_results')
                .select('month')
                .eq('student_id', currentStudent.id)
                .eq('trade_id', currentStudent.trade);

            const completedMonths = results ? results.map(r => r.month) : [];

            // Check schedule
            const { data: schedules } = await supabase
                .from('test_schedule')
                .select('*')
                .eq('trade_id', currentStudent.trade);

            const today = new Date().toISOString().split('T')[0];

            container.innerHTML = '';
            for (let month = 1; month <= 4; month++) {
                const completed = completedMonths.includes(month);
                
                const schedule = schedules?.find(s => s.month === month);
                const isLocked = schedule && (today < schedule.start_date || today > schedule.end_date);

                const btn = document.createElement('div');
                btn.className = `month-btn ${completed ? 'completed' : ''} ${isLocked ? 'locked' : ''}`;
                btn.innerHTML = `Month ${month}`;
                
                if (completed) {
                    btn.onclick = () => alert('You have already completed this test!');
                } else if (isLocked) {
                    btn.onclick = () => alert('This test is not available yet!');
                } else {
                    btn.onclick = () => startTest(month);
                }
                
                container.appendChild(btn);
            }
        }

        async function startTest(month) {
            currentMonth = month;
            
            // Load questions
            const { data, error } = await supabase
                .from('questions')
                .select('*')
                .eq('trade_id', currentStudent.trade)
                .eq('month', month);

            if (error || !data || data.length === 0) {
                alert('No questions available for this month!');
                return;
            }

            questions = data.map(q => ({
                id: q.id,
                question: q.question,
                options: {
                    A: q.option_a,
                    B: q.option_b,
                    C: q.option_c,
                    D: q.option_d
                },
                correct: q.correct_answer
            }));

            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length).fill(null);
            timeLeft = 30 * 60; // 30 minutes

            showScreen('testScreen');
            document.getElementById('currentMonth').textContent = `Month ${month}`;
            
            const { data: tradeData } = await supabase
                .from('trades')
                .select('name')
                .eq('id', currentStudent.trade)
                .single();
            
            document.getElementById('currentTrade').textContent = tradeData?.name || currentStudent.trade;
            
            initAntiCheat();
            enterFullscreen();
            startTimer();
            displayQuestion();
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            const container = document.getElementById('questionContainer');
            
            container.innerHTML = `
                <div class="question">
                    <h3>Question ${currentQuestionIndex + 1} of ${questions.length}</h3>
                    <p>${question.question}</p>
                    ${['A', 'B', 'C', 'D'].map(opt => `
                        <label class="option ${userAnswers[currentQuestionIndex] === opt ? 'selected' : ''}">
                            <input type="radio" name="answer" value="${opt}" 
                                ${userAnswers[currentQuestionIndex] === opt ? 'checked' : ''}
                                onchange="selectAnswer('${opt}')">
                            <span class="option-text">${opt}. ${question.options[opt]}</span>
                        </label>
                    `).join('')}
                </div>
            `;

            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').textContent = 
                currentQuestionIndex === questions.length - 1 ? 'Submit Test' : 'Next ‚û°Ô∏è';
            
            updateProgress();
        }

        function selectAnswer(answer) {
            userAnswers[currentQuestionIndex] = answer;
            displayQuestion();
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                submitTest(false);
            }
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('questionCounter').textContent = 
                `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest(true);
                }
            }, 1000);
        }

        async function submitTest(autoSubmit) {
            clearInterval(timerInterval);
            
            if (!autoSubmit && !confirm('Are you sure you want to submit the test?')) {
                startTimer();
                return;
            }

            let score = 0;
            questions.forEach((q, i) => {
                if (userAnswers[i] === q.correct) score++;
            });

            // Save to database
            const { error } = await supabase.from('test_results').insert({
                student_name: currentStudent.name,
                student_id: currentStudent.id,
                trade_id: currentStudent.trade,
                month: currentMonth,
                score: score,
                total_questions: questions.length
            });

            if (error) {
                console.error('Error saving result:', error);
                alert('Error saving result. Please contact administrator.');
                return;
            }

            // Exit fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }

            showScreen('resultScreen');
            document.getElementById('scoreDisplay').textContent = `${score}/${questions.length}`;
            
            const { data: tradeData } = await supabase
                .from('trades')
                .select('name')
                .eq('id', currentStudent.trade)
                .single();
            
            document.getElementById('resultDetails').innerHTML = `
                <p><strong>Name:</strong> <span>${currentStudent.name}</span></p>
                <p><strong>ID:</strong> <span>${currentStudent.id}</span></p>
                <p><strong>Trade:</strong> <span>${tradeData?.name || currentStudent.trade}</span></p>
                <p><strong>Month:</strong> <span>${currentMonth}</span></p>
                <p><strong>Score:</strong> <span>${score}/${questions.length}</span></p>
                <p><strong>Percentage:</strong> <span>${((score/questions.length)*100).toFixed(1)}%</span></p>
                ${autoSubmit ? '<p class="warning">‚ö†Ô∏è Test was auto-submitted</p>' : ''}
            `;
        }

        // TEACHER FUNCTIONS
        function showTeacherLogin() {
            showScreen('teacherLoginScreen');
        }

        function showTeacherRegister() {
            showScreen('teacherRegisterScreen');
        }

        async function registerTeacher() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const trade = document.getElementById('regTrade').value;

            if (!name || !email || !username || !password || !trade) {
                document.getElementById('registerError').textContent = 'Please fill all fields!';
                return;
            }

            // Check if username exists
            const { data: existing } = await supabase
                .from('teachers')
                .select('username')
                .eq('username', username)
                .single();

            if (existing) {
                document.getElementById('registerError').textContent = 'Username already exists!';
                return;
            }

            // Insert teacher
            const { error } = await supabase.from('teachers').insert({
                name: name,
                email: email,
                username: username,
                password: password, // In production, hash this!
                trade_id: trade
            });

            if (error) {
                document.getElementById('registerError').textContent = 'Registration failed!';
                console.error(error);
                return;
            }

            document.getElementById('registerSuccess').textContent = 'Registration successful! Please login.';
            setTimeout(() => showTeacherLogin(), 2000);
        }

        async function teacherLogin() {
            const username = document.getElementById('teacherUsername').value.trim();
            const password = document.getElementById('teacherPassword').value.trim();

            const { data, error } = await supabase
                .from('teachers')
                .select('*')
                .eq('username', username)
                .eq('password', password)
                .single();

            if (error || !data) {
                document.getElementById('teacherLoginError').textContent = 'Invalid credentials!';
                return;
            }

            currentTeacher = data;
            showScreen('teacherPanel');
            await loadTeacherData();
        }

        function teacherLogout() {
            currentTeacher = null;
            document.getElementById('teacherUsername').value = '';
            document.getElementById('teacherPassword').value = '';
            showScreen('loginScreen');
        }

        async function loadTeacherData() {
            await loadResults();
            await loadScheduleManagement();
        }

        function switchTeacherTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'results') loadResults();
            if (tab === 'questions') loadQuestions();
            if (tab === 'schedule') loadScheduleManagement();
        }

        async function loadResults() {
            const { data: results } = await supabase
                .from('test_results')
                .select('*')
                .eq('trade_id', currentTeacher.trade_id)
                .order('completed_at', { ascending: false });

            const container = document.getElementById('resultsContainer');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No results yet</p>';
                return;
            }

            const { data: tradeData } = await supabase
                .from('trades')
                .select('name')
                .eq('id', currentTeacher.trade_id)
                .single();

            let html = '<table><thead><tr><th>Name</th><th>ID</th><th>Month</th><th>Score</th><th>Date</th></tr></thead><tbody>';
            
            results.forEach(result => {
                html += `
                    <tr>
                        <td>${result.student_name}</td>
                        <td>${result.student_id}</td>
                        <td>Month ${result.month}</td>
                        <td>${result.score}/${result.total_questions}</td>
                        <td>${new Date(result.completed_at).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function exportResults() {
            const { data: results } = await supabase
                .from('test_results')
                .select('*')
                .eq('trade_id', currentTeacher.trade_id)
                .order('completed_at', { ascending: false });

            if (!results || results.length === 0) {
                alert('No results to export!');
                return;
            }

            let csv = 'Name,ID,Month,Score,Total,Percentage,Date\n';
            
            results.forEach(r => {
                const percentage = ((r.score / r.total_questions) * 100).toFixed(1);
                csv += `${r.student_name},${r.student_id},${r.month},${r.score},${r.total_questions},${percentage}%,${new Date(r.completed_at).toLocaleString()}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test_results.csv';
            a.click();
        }

        async function loadQuestions() {
            const month = document.getElementById('filterMonth').value;
            const container = document.getElementById('questionsContainer');

            if (!month) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Please select month</p>';
                return;
            }

            const { data: questions } = await supabase
                .from('questions')
                .select('*')
                .eq('trade_id', currentTeacher.trade_id)
                .eq('month', month);

            if (!questions || questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No questions found</p>';
                return;
            }

            let html = '';
            questions.forEach((q, index) => {
                html += `
                    <div class="question-card">
                        <h4>Q${index + 1}: ${q.question}</h4>
                        <p>A) ${q.option_a} ${q.correct_answer === 'A' ? '‚úÖ' : ''}</p>
                        <p>B) ${q.option_b} ${q.correct_answer === 'B' ? '‚úÖ' : ''}</p>
                        <p>C) ${q.option_c} ${q.correct_answer === 'C' ? '‚úÖ' : ''}</p>
                        <p>D) ${q.option_d} ${q.correct_answer === 'D' ? '‚úÖ' : ''}</p>
                        <div class="question-actions">
                            <button class="btn-small btn-warning" onclick="editQuestion('${q.id}')">‚úèÔ∏è Edit</button>
                            <button class="btn-small btn-danger" onclick="deleteQuestion('${q.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function openAddQuestionModal() {
            editingQuestionId = null;
            document.getElementById('modalTitle').textContent = 'Add Question';
            document.getElementById('questionForm').reset();
            document.getElementById('questionModal').classList.add('active');
        }

        async function editQuestion(id) {
            const { data: q } = await supabase
                .from('questions')
                .select('*')
                .eq('id', id)
                .single();

            if (!q) return;

            editingQuestionId = id;
            document.getElementById('modalTitle').textContent = 'Edit Question';
            document.getElementById('modalMonth').value = q.month;
            document.getElementById('modalQuestion').value = q.question;
            document.getElementById('modalOptionA').value = q.option_a;
            document.getElementById('modalOptionB').value = q.option_b;
            document.getElementById('modalOptionC').value = q.option_c;
            document.getElementById('modalOptionD').value = q.option_d;
            document.getElementById('modalCorrect').value = q.correct_answer;
            
            document.getElementById('questionModal').classList.add('active');
        }

        async function deleteQuestion(id) {
            if (!confirm('Delete this question?')) return;

            const { error } = await supabase
                .from('questions')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error deleting question!');
                return;
            }

            loadQuestions();
        }

        async function saveQuestion(e) {
            e.preventDefault();

            const questionData = {
                trade_id: currentTeacher.trade_id,
                month: parseInt(document.getElementById('modalMonth').value),
                question: document.getElementById('modalQuestion').value,
                option_a: document.getElementById('modalOptionA').value,
                option_b: document.getElementById('modalOptionB').value,
                option_c: document.getElementById('modalOptionC').value,
                option_d: document.getElementById('modalOptionD').value,
                correct_answer: document.getElementById('modalCorrect').value,
                teacher_id: currentTeacher.id
            };

            let error;
            if (editingQuestionId) {
                ({ error } = await supabase
                    .from('questions')
                    .update(questionData)
                    .eq('id', editingQuestionId));
            } else {
                ({ error } = await supabase
                    .from('questions')
                    .insert(questionData));
            }

            if (error) {
                alert('Error saving question!');
                console.error(error);
                return;
            }

            closeQuestionModal();
            loadQuestions();
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').classList.remove('active');
        }

        async function loadScheduleManagement() {
            const { data: schedules } = await supabase
                .from('test_schedule')
                .select('*')
                .eq('trade_id', currentTeacher.trade_id);

            const container = document.getElementById('scheduleContainer');
            let html = '<div class="settings-grid">';

            for (let month = 1; month <= 4; month++) {
                const schedule = schedules?.find(s => s.month === month);

                html += `
                    <div class="settings-card">
                        <h4>Month ${month}</h4>
                        <label style="color: #ddd; display: block; margin: 10px 0;">Start Date</label>
                        <input type="date" id="start_${month}" value="${schedule?.start_date || ''}">
                        <label style="color: #ddd; display: block; margin: 10px 0;">End Date</label>
                        <input type="date" id="end_${month}" value="${schedule?.end_date || ''}">
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        async function saveSchedule() {
            for (let month = 1; month <= 4; month++) {
                const startDate = document.getElementById(`start_${month}`).value;
                const endDate = document.getElementById(`end_${month}`).value;

                if (!startDate || !endDate) continue;

                const { error } = await supabase
                    .from('test_schedule')
                    .upsert({
                        trade_id: currentTeacher.trade_id,
                        month: month,
                        start_date: startDate,
                        end_date: endDate,
                        teacher_id: currentTeacher.id
                    }, {
                        onConflict: 'trade_id,month'
                    });

                if (error) {
                    console.error('Error saving schedule:', error);
                }
            }

            alert('Schedule saved successfully!');
        }

        function backToStudentLogin() {
            showScreen('loginScreen');
        }

        function backToLogin() {
            currentStudent = null;
            currentTrade = null;
            currentMonth = null;
            showScreen('loginScreen');
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Initialize on load
        initializeSystem();
    </script>
</body>
</html>